# IP协议

## IP地址含义

现在的IP网络使用32位地址，以点分十进制表示，如172.16.0.0。地址格式为：IP地址=网络地址＋主机地址 或 IP地址=主机地址＋子网地址＋主机地址。

## IP地址分类

最初设计互联网络时，为了便于寻址以及层次化构造网络，每个IP地址包括两个标识码（ID），即网络ID和主机ID。同一个物理网络上的所有主机都使用同一个网络ID，网络上的一个主机（包括网络上工作站，服务器和路由器等）有一个主机ID与其对应。IP地址根据网络ID的不同分为5种类型，A类地址、B类地址、C类地址、D类地址和E类地址。

### A类IP地址

一个A类IP地址由1字节的网络地址和3字节主机地址组成，它主要为大型网络而设计的，网络地址的最高位必须是“0”， 地址范围从1.0.0.0 到127.0.0.0。其中0代表任何地址，其中127.0.0.1是一个特殊的IP地址，表示主机本身，用于本地机器的测试，为回环测试地址，因此，A类ip地址的实际范围是1-126。默认子网掩码为255.0.0.0，**每个网络能容纳1亿多个主机（怎么计算的？）**。

### B类IP地址

一个B类IP地址由2个字节的网络地址和2个字节的主机地址组成，网络地址的最高位必须是“10”，地址范围从128.0.0.0到191.255.255.255。可用的B类网络有16382个，每个网络能容纳6万多个主机 。其中128.0.0.0和191.255.0.0为保留ip，实际范围是128.1.0.0--191.254.0.0。

### C类IP地址

一个C类IP地址由3字节的网络地址和1字节的主机地址组成，网络地址的最高位必须是“110”。范围从192.0.0.0到223.255.255.255。C类网络可达209万余个，每个网络能容纳254个主机。 其中192.0.0.0和223.255.255.0为保留ip，实际范围是192.0.1.0--223.255.254.0。

### D类IP地址

D类IP地址第一个字节以“lll0”开始，它是一个保留的地址。它并不指向特定的网络，目前这一类地址被用在多点广播（Multicast）中。多点广播地址用来一次寻址一组计算机，它标识共享同一协议的一组计算机。 224.0.0.0到239.255.255.255用于多点广播 。

### E类IP地址

E类IP地址 以“llll0”开始，为将来使用保留。240.0.0.0到255.255.255.254，255.255.255.255用于广播地址全零（“0．0．0．0”）地址对应于当前主机。全“1”的IP地址（“255．255．255．255”）是当前子网的广播地址。

## 其他

在IP地址3种主要类型里，各保留了3个区域作为私有地址，其地址范围如下： 

A类地址：10.0.0.0～10.255.255.255 

B类地址：172.16.0.0～172.31.255.255 

C类地址：192.168.0.0～192.168.255.255

# 单播（unicast）

是指封包在计算机网络的传输中，目的地址为单一目标的一种传输方式。它是现今网络应用最为广泛，通常所使用的网络协议或服务大多采用单播传输，例如一切基于TCP的协议。

每次只有两个实体相互通信，发送端和接收端都是唯一确定的。

在IPv4网络中，0.0.0.0到223.255.255.255属于单播地址。

# 组播\(multicast\)：又称多播，多点广播，群播

指把信息同时传递给一组目的地址。它使用策略是最高效的，因为消息在每条网络链路上只需传递一次，而且只有在链路分叉的时候，消息才会被复制。组播”这个词通常用来指代IP组播。IP组播是一种通过使用一个组播地址将数据在同一时间以高效的方式发往处于TCP/IP网络上的多个接收者的协议。此外，它还常用来与RTP等音视频协议相结合。

组播报文的目的地址使用D类IP地址， D类地址不能出现在IP报文的源IP地址字段。

# 广播\(broadcast\)

## 广播域

广播域是网络中能接收任一台主机发出的广播帧的所有主机集合。也就是说，如果广播域内的其中一台主机发出一个广播帧，同一广播域内所有的其它主机都可以收到该广播帧。

## 广播域的计算

如何知道一台主机是属于哪一个广播域呢？其实计算很简单，只要用主机的IP地址与子网掩码进行与运算即可知道该主机属于哪一个广播域。例如：一台主机的IP地址为192.168.23.150，子网掩码为255.255.255.0，那么它所属的广播域就是192.168.23.150&255.255.255.0=192.168.23.0。那么其它的在广播域192.168.23.0内的所有主机就可以到该设备发送的广播包。如果把子网掩码改为255.255.0.0，那么它所属的广播域就是192.168.23.150&255.255.0.0=192.168.0.0。那么其它的在广播域192.168.0.0内的所有主机都可以收到该设备发送的广播包。

## 广播地址的计算

要想相同广播域内的其它主机能收到的广播帧，还需要在发送广播包的时候指定当前所属广播域内的广播地址。广播地址的计算方法为子网掩码取反再与广播域进行或运算。

例如：如果主机当前所属广播域为192.168.0.0，子网掩码为255.255.0.0，那么广播地址则为192.168.255.255。

## 跨网段广播

要使主机A发送的广播包能够被另一网段的主机B收到，那么只需要更改主机A的子网掩码使得与主机B在同一个广播域内，再使用新的广播域的广播地址发送广播包即可。

例如：要使用192.168.23.150发送广播包让192.168.27.135收到，只需要设置192.168.23.150的子网掩码为255.255.0.0，然后再使用广播地址192.168.255.255即可。

特别要指出的是：255.255.255.255是受限广播地址，不能使用该地址发送广播包。

# 任播\(anycast\)

任播是IPv6中的概念，在IPv6中没有广播的概念。IPv4中广播的功能在IPv6中由任播代替。

任播\(anycast\):是一种网络寻址和路由的策略，使得资料可以根据路由拓朴来决定送到“最近”或“最好”的目的地。

在任播中，在网络位址和网络节点之间存在一对多的关系：每一个位址对应一群接收节点，但在任何给定时间，只有其中之一可以接收到传送端来的资讯。

在互联网中，通常使用边界网关协议来实现任播。


# 网络掩码
## 1
从前有一个地主，有256间房子，地主家的门牌号码是“192.168.1”，那么他家第一间房子的门牌号码是192.168.1.0，第二间是192.168.1.1，…第256间的编号是192.168.1.255。

地主老了，需要把256间房子分给4个儿子，平均分配，每个儿子可以分64间。

请来一位先生主持公道，先生这么来操作：
- 192.168.1.0-192.168.1.63 分给大儿子
- 192.168.1.64-192.168.1.127 分给二儿子
- 192.168.1.128 -192.168.1.191 分给三儿子
- 192.168.1.192-192.168.1.255 分给四儿子

那如何来描述四个儿子的子网网段呢？
- 192.168.1.0/26
- 192.168.1.64/26
- 192.168.1.128/26
- 192.168.1.192/26

/26是什么鬼？

255.255.255.192的二进制是多少？ 

“11111111-11111111-11111111-11”大家数数一共多少个1？不用数了，是26个1，为了简化子网掩码的表示，用/26代替255.255.255.192。

按位与运算

我们来看大儿子的网段192.168.1.0/26是如何得到的？

以大儿子的房间为例：192.168.1.0-192.168.1.63

二进制表示：192.168.1.0

11000000.10101000.00000001.00000000

192.168.1.63

11000000.10101000.00000001.00111111

首尾地址完全相同的是多少？

11000000.10101000.00000001.00

数数一共多少位？26位！那么用这个“192.168.1.0/26”就可以表示大儿子所有房间。

对照房间的门牌号码“192.168.1.199”，很显然属于四儿子的。

一个主机192.168.1.199/26 能否和直连主机192.168.1.200/24 通信？可以的，因为都是四儿子的房间。

一个主机192.168.1.199/26 能否和直连主机192.168.1.1/24 通信？ 不可以，因为一个是大儿子的房间，一个是四儿子的房间，无法直连通信！

## 2
通信大体有三种方式：

- 自己与自己的通信
- 与广播域主机通信
- 与别的广播域主机通信

假如主机只有IP地址，如何知道要通信的主机IP，是以上哪一种方式？

### 网络掩码

网络掩码做为一个辅助工具，可以帮助主机区分以上三种情况，所以网络掩码是必不可少的，和IP地址如影相随。

最初的网络掩码长度为8的整数倍，8、16、24、32，这里的长度为二进制的长度，即一个字节长度的整数倍。

1.1.1.1/8

这个组合经常出现的路由器的配置里，其中“1.1.1.1”为IP地址。“/8”表示网络掩码的长度，8个二进制长度。

172.16.1.1/16

“172.16.1.1”为IP地址。“/16”表示网络掩码的长度，16个二进制长度。

192.168.1.1/24

“192.168.1.1”为IP地址。“/24”表示网络掩码的长度，24个二进制长度。

127.0.0.1/32

“127.0.0.1”为IP地址。“/32”表示网络掩码的长度，32个二进制长度。

但是，这种网络掩码的颗粒度太大，不够精细。

举一个例子，客户希望一个网段可以容纳1000台主机，使用哪个网络掩码呢？

/24掩码肯定不行，这个掩码只能容纳256个IP地址，最多容纳256台主机。

/16掩码可以是可以，可以容纳65536个IP地址，将会浪费64536个IP地址，因为这些IP地址别的网段还不能使用。

自然就会产生精细化的网络掩码需求，这个就是子网掩码。

子网掩码

如果不对掩码长度是8的整数倍做强制要求，那么就实现精细化的子网掩码。

将172.16.1.1/16的16扩展到22，将会产生64个子网段，每个网段可以容纳1024台主机。

172.16.0.0/22

172.16.4.0/22

172.16.8.0/22

172.16.12.0/22

…

172.16.244.0/22

172.16.248.0/22

172.16.252.0/22

注意了，22可不是8的整数倍！

如果把网络掩码16比作爸爸，那么子网掩码22自然就是儿子，因为有64个儿子分掉爸爸65536个IP地址，每个儿子分1024个IP地址。

如果子网掩码是23，意味着将会有128个儿子叫爸爸，儿子们将分掉爸爸的65536个IP地址，每个儿子分得512个IP地址。

另外需要注意的是，当172.16.0.0/22表示时，通常表示这是一个网段IP的集合，1024个IP的集合。172.16.0.1/22通常表示一个个体IP 。换句话说，一旦子网掩码没有覆盖的地方不为0时，表示一个IP地址。

## 参考
https://www.zhihu.com/question/56895036/answer/150953183
https://cloud.tencent.com/info/f38b95c8a1edf8acb2f885e68f4b45e4.html



