# UDP可靠传输

## 案例需求
### 对可靠行的需求层度
- 有序可靠？(本案例要求有序可靠,有序可靠可配置)
- 无序可靠？(本案例要求无序可靠,有序可靠可配置)
- 尽量可靠？
### 网络环境
- 带宽有多大？（本案例200M）
- 数据量多大？（日访问千万级别）
- 线路节点图？
- 接收端和发送端的IP是否固定？（固定IP)


## 可靠性基本架构

```
graph TD

subgraph dataPoint0
dataPoint0
signallingPoint0
end
fireWall[网络环境]
subgraph dataPoint1
dataPoint1
signallingPoint1
end

dataPoint0 -- 应用数据 --> fireWall
fireWall -- 应用数据 --> dataPoint1
signallingPoint1 -- 应用信令 --> fireWall
fireWall -- 应用信令 --> signallingPoint0

```

## 协议
- 订场包头
- 变长包体

## 包大小
- 固定容量

## 数据流转示意图
![数据流转示意图](images/udp-demo-sketch.jpg)

## 架构示意图
![架构示意图](images/udp-demo-single.jpg)

## 发送端流程图
![发送端流程图](images/udp-demo-sender-sequence.jpg)

## 接收端流程图
![接收端流程图](images/udp-demo-receiver-sequence.jpg)

## 可靠性测试环境
端别 | CPU | 内存 | 网卡 | 系统参数 |   
-|-|-|-|-|-
发送端 |
接收端 |
链路描述：？

## 可靠性测试方法
- 日访问量：千万级别或亿级别
- 并发量：0.1K~1K~10K
- 单个访问数据大小：[548字节~1472字节](protocol.md)~64K随机
- 单包数据量；待定
- 给测试数据编号
- 给测试数据结尾添加两个字节的固定测试数据
- 接收端记录序号
- 接收端判断结尾两个字节的数据
- 调整机器时间，给数据包添加发送时间，接收端记录耗时


## 纯粹的UDP收发测试
并发量 | 发送数据总量 |  丢包率 | 总耗时 | 平均耗时 | 最大耗时 | 最小耗时
-|-|-|-|-|-|-|
0.1k | 1G |  | | | | |
0.1k | 10G |  | |
0.1k | 100G |  | |
1k | 1G |  | |
1k | 10G |  | |
1k | 100G |  | |
10k | 1G |  | |
10k | 10G |  | |
10k | 100G |  | |

## 添加重传机制的UDP收发测试（无序）
并发量 | 发送数据总量 |  丢包率 | 总耗时 | 平均耗时 | 最大耗时 | 最小耗时
-|-|-|-|-|-|-|
0.1k | 1G |  | | | | |
0.1k | 10G |  | |
0.1k | 100G |  | |
1k | 1G |  | |
1k | 10G |  | |
1k | 100G |  | |
10k | 1G |  | |
10k | 10G |  | |
10k | 100G |  | |
## 添加重传机制的UDP收发测试（有序）
并发量 | 发送数据总量 |  丢包率 | 总耗时 | 平均耗时 | 最大耗时 | 最小耗时
-|-|-|-|-|-|-|
0.1k | 1G |  | | | | |
0.1k | 10G |  | |
0.1k | 100G |  | |
1k | 1G |  | |
1k | 10G |  | |
1k | 100G |  | |
10k | 1G |  | |
10k | 10G |  | |
10k | 100G |  | |

## 临测
```
丢失率：38/100000=3.8E-4
[最大耗时：(80:251ms)]
[最小耗时：(99999:0ms)]
[平均耗时：(99962:0.21108021ms)]
[总耗时：(21100ms)]
发送并发量：100
发送任务量：1000
总任务量：100000
总数据量：104.07164919019934M
发送执行总时长：102614ms
```
```
丢包率：29/10000=0.0029
[最大耗时：(15:199ms)]
[最小耗时：(9999:0ms)]
[平均耗时：(9971:1.2355832ms)]
[总耗时：(12320ms)]
发送并发量：100
发送任务量：100
总任务量：10000
总数据量：10.356578332641195M
发送执行总时长：11615ms
```
```
丢包率：2/1000=0.002
[最大耗时：(1:116ms)]
[最小耗时：(999:0ms)]
[平均耗时：(998:2.0771544ms)]
[总耗时：(2073ms)]
发送并发量：10
发送任务量：100
总任务量：1000
总数据量：1.0502418695494187M
发送执行总时长：11576ms
```

```
无丢包
[最大耗时：(0:120ms)]
[最小耗时：(91:0ms)]
[平均耗时：(100:2.36ms)]
[总耗时：(236ms)]
发送并发量：1
发送任务量：100
总任务量：100
总数据量：0.10630012588247509M
发送执行总时长：11594ms
```
```
无丢包
[最大耗时：(0:116ms)]
[最小耗时：(999:0ms)]
[平均耗时：(1000:1.012ms)]
[总耗时：(1012ms)]
发送并发量：1
发送任务量：1000
总任务量：1000
总数据量：1.033070915957226M
发送执行总时长：102909ms
```

## 参考资料
- [RUDP](https://www.jianshu.com/p/4d12ad2e7500)
